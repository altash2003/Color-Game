<!DOCTYPE html>
<html>
<head>
    <title>ADMIN PANEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rajdhani', sans-serif; background: #111; color: white; display: grid; grid-template-columns: 250px 1fr; height: 100vh; margin: 0; }
        .sidebar { background: #1a1a1a; padding: 20px; border-right: 1px solid #333; }
        .main { padding: 20px; display: grid; grid-template-rows: auto 1fr; gap: 20px; }
        .panel { background: #222; border: 1px solid #333; padding: 20px; border-radius: 8px; }
        input, button { padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; }
        button { cursor: pointer; font-weight: bold; } button:hover { background: #444; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .chat-box { height: 300px; overflow-y: auto; background: #000; border: 1px solid #333; padding: 10px; margin-bottom: 10px; font-size: 13px; }
    </style>
</head>
<body>
    <div id="loginOverlay" style="position:fixed; inset:0; background:#000; display:flex; justify-content:center; align-items:center; z-index:99;">
        <div style="text-align:center;">
            <h2>ADMIN LOGIN</h2>
            <input id="aUser" placeholder="Username"><br><br>
            <input id="aPass" type="password" placeholder="Password"><br><br>
            <button onclick="login()">LOGIN</button>
        </div>
    </div>

    <div class="sidebar">
        <h3>CONTROLS</h3>
        <div id="userList" style="font-size:12px; color:#aaa;"></div>
    </div>

    <div class="main">
        <div class="panel">
            <h3>MUSIC CONTROL</h3>
            <div class="row">
                <input id="mUrl" placeholder="Track URL" style="flex:1;">
                <button onclick="loadTrack()">LOAD</button>
            </div>
            <div class="row">
                <input id="mTitle" placeholder="Title">
                <input id="mArtist" placeholder="Artist">
                <button onclick="updMeta()">UPDATE META</button>
            </div>
            <div class="row">
                <button onclick="music('play')">PLAY</button>
                <button onclick="music('pause')">PAUSE</button>
                <input type="range" min="0" max="200" onchange="music('seek', this.value)">
            </div>
        </div>

        <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>
                <h3>PUBLIC CHAT</h3>
                <div id="chatPub" class="chat-box"></div>
                <div class="row"><input id="msgPub" style="flex:1;"><button onclick="sendPub()">SEND</button></div>
            </div>
            <div>
                <h3>SUPPORT TICKETS</h3>
                <div id="chatSup" class="chat-box"></div>
                <div class="row"><input id="supTarget" placeholder="Username" style="width:100px;"><input id="msgSup" style="flex:1;"><button onclick="replySup()">REPLY</button></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let token = localStorage.getItem('admTok');
        if(token) socket.emit('auth_handshake', {type:'admin', token});

        function login() {
            const u=document.getElementById('aUser').value, p=document.getElementById('aPass').value;
            fetch('/api/admin/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})})
            .then(r=>r.json()).then(d=>{
                if(d.token) { localStorage.setItem('admTok', d.token); location.reload(); }
            });
        }

        socket.on('auth_success', () => document.getElementById('loginOverlay').style.display='none');
        
        socket.on('active_players_update', (l) => {
            document.getElementById('userList').innerHTML = l.map(u=>`<div>${u.username} [${u.role}]</div>`).join('');
        });

        socket.on('chat_broadcast', (d) => {
            if(d.type==='public') {
                document.getElementById('chatPub').innerHTML += `<div><b>${d.user}:</b> ${d.msg}</div>`;
            } else if(d.type==='support_reply') {
                document.getElementById('chatSup').innerHTML += `<div><b style="color:cyan">ADMIN -> ${d.msg}</b></div>`;
            }
        });
        
        socket.on('support_rx', (t) => {
            document.getElementById('chatSup').innerHTML += `<div><b style="color:yellow">${t.user}:</b> ${t.msg}</div>`;
        });

        function loadTrack() { socket.emit('admin_change_track', document.getElementById('mUrl').value); }
        function updMeta() { socket.emit('admin_update_metadata', {title:document.getElementById('mTitle').value, artist:document.getElementById('mArtist').value}); }
        function music(act, val) { socket.emit('admin_music_action', {action:act, seek:val}); }
        
        function sendPub() { socket.emit('admin_chat_public', document.getElementById('msgPub').value); document.getElementById('msgPub').value=''; }
        function replySup() { socket.emit('admin_reply_support', {target:document.getElementById('supTarget').value, msg:document.getElementById('msgSup').value}); }
    </script>
</body>
</html>
