<!DOCTYPE html>
<html>
<head>
    <title>ADMIN DASHBOARD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) { return false; } 
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
        }
    </script>

    <style>
        :root { --panel-bg: rgba(20, 22, 28, 0.9); --border: rgba(255, 255, 255, 0.1); --gold: #FFD700; --cyan: #00E5FF; --green: #00C853; --red: #FF3D00; --text-main: #E6EDF3; --text-dim: #8B949E; }
        body { font-family: 'Inter', sans-serif; margin: 0; color: var(--text-main); background: url('background.jpg') no-repeat center center fixed; background-size: cover; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .no-scroll-ui::-webkit-scrollbar { display: none; }
        .no-scroll-ui { -ms-overflow-style: none; scrollbar-width: none; }
        
        #loginScreen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: #1a1d24; border: 1px solid #333; padding: 40px; border-radius: 12px; width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; border-radius: 6px; }
        
        .admin-wrapper { background: var(--panel-bg); backdrop-filter: blur(15px); border: 1px solid var(--border); border-radius: 12px; width: 96%; max-width: 1600px; height: 92vh; padding: 0; display: flex; box-shadow: 0 20px 60px rgba(0,0,0,0.8); overflow: hidden; }
        .sidebar { width: 250px; background: rgba(0,0,0,0.3); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .main-content { flex: 1; padding: 20px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; overflow-y: auto; }
        
        .section-title { color: #888; font-size: 11px; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; margin-top: 20px; text-transform: uppercase; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .panel-box { background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        .panel-header { font-weight: bold; color: var(--gold); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* MUSIC */
        .music-preview { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 10px; }
        .song-container { display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; overflow: hidden; height: 34px; }
        .title-wrap { width: 100%; overflow: hidden; white-space: nowrap; text-align: center; }
        .music-title { font-size: 13px; font-weight: 700; color: white; display: inline-block; font-family: 'Rajdhani', sans-serif; }
        .music-artist { font-size: 10px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; font-family: 'Rajdhani', sans-serif; }
        .marquee { animation: scroll-left 8s linear infinite; padding-left: 100%; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .music-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .music-input { background: #222; border: 1px solid #333; color: white; padding: 5px; border-radius: 4px; flex: 1; }
        
        /* DATABASE */
        .db-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .db-table th { text-align: left; color: #888; padding: 5px; border-bottom: 1px solid var(--border); }
        .db-table td { padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .status-dot { width: 8px; height: 8px; background: #444; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--green); box-shadow: 0 0 5px var(--green); }
        
        /* CHAT */
        .chat-area { flex: 1; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-size: 12px; margin-bottom: 10px; height: 250px; }
        .chat-input-row { display: flex; gap: 5px; }
        .chat-input { flex: 1; background: #222; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; }
        .btn-small { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-small:hover { background: #444; }
        .staff-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #333; }
        .badge-ADMIN { background: var(--gold); color: black; }
        .badge-MOD { background: var(--cyan); color: black; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:var(--gold); margin-top:0;">SYSTEM ACCESS</h2>
            <input type="text" id="adminUser" class="login-input" placeholder="Username">
            <input type="password" id="adminPass" class="login-input" placeholder="Password">
            <button onclick="performLogin()" class="login-btn">LOGIN</button>
            <div style="color:#ff4444; font-size:12px; margin-top:10px;" id="loginError"></div>
        </div>
    </div>

    <div class="admin-wrapper">
        <div class="sidebar">
            <h3 style="color:white; margin:0;">ADMIN PANEL</h3>
            <div style="font-size:12px; color:#666;" id="myIdentity">...</div>
            
            <div class="section-title">ACTIVE STAFF</div>
            <div id="staffList"></div>

            <div class="section-title">SYSTEM</div>
            <div class="stat-row"><span>Status</span> <span style="color:var(--green)">Online</span></div>
            
            <div class="section-title" style="color:var(--cyan); border-top:1px solid #333; padding-top:10px;">CREATE STAFF</div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <input type="text" id="newStaffUser" class="login-input" style="padding:8px; margin:0;" placeholder="Username">
                <input type="text" id="newStaffPass" class="login-input" style="padding:8px; margin:0;" placeholder="Password">
                <select id="newStaffRole" class="login-input" style="padding:8px; margin:0;">
                    <option value="MOD">MODERATOR</option>
                    <option value="ADMIN">ADMINISTRATOR</option>
                </select>
                <button class="btn-small" style="background:var(--cyan); color:black; font-weight:bold;" onclick="createStaff()">CREATE ACCOUNT</button>
            </div>

            <button class="btn-small" style="width:100%; margin-top:20px; border-color:var(--red); color:var(--red);" onclick="performLogout()">LOGOUT</button>
        </div>

        <div class="main-content">
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="panel-box">
                    <div class="panel-header">MUSIC CONTROLLER <audio id="adminAudio"></audio></div>
                    <div class="music-preview">
                        <i class="fas fa-music" style="color:var(--gold); font-size:18px;"></i>
                        <div class="song-container">
                            <div class="title-wrap"><span id="musicTitle" class="music-title">Waiting...</span></div>
                            <div id="musicArtist" class="music-artist"></div>
                        </div>
                    </div>
                    <div class="music-row">
                        <input id="mTitle" class="music-input" placeholder="Title">
                        <input id="mArtist" class="music-input" placeholder="Artist">
                        <button class="btn-small" onclick="updateMeta()">UPDATE TEXT</button>
                    </div>
                    <div class="music-row">
                        <input id="mUrl" class="music-input" placeholder="MP3 URL">
                        <button class="btn-small" onclick="changeTrack()" style="color:var(--red)">LOAD</button>
                    </div>
                    <div class="music-row" style="justify-content: center;">
                        <button class="btn-small" onclick="toggleMusic(true)"><i class="fas fa-play"></i></button>
                        <button class="btn-small" onclick="toggleMusic(false)"><i class="fas fa-pause"></i></button>
                        <input type="range" min="0.05" max="0.5" step="0.05" onchange="document.getElementById('adminAudio').volume=this.value">
                    </div>
                </div>

                <div class="panel-box" style="flex:1;">
                    <div class="panel-header">
                        PLAYER DATABASE
                        <div style="display:flex; gap:5px;">
                            <button class="btn-small" onclick="addAll()">GIFT ALL</button>
                            <button class="btn-small" onclick="reqRefresh()">REFRESH</button>
                        </div>
                    </div>
                    <div style="overflow:auto; max-height: 400px;">
                        <table class="db-table">
                            <thead><tr><th>User</th><th>Role</th><th>Bal</th><th>Actions</th></tr></thead>
                            <tbody id="dbBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="panel-box">
                    <div class="panel-header">BROADCAST</div>
                    <div class="chat-input-row">
                        <input id="annoInput" class="chat-input" placeholder="Alert Message...">
                        <button class="btn-small" style="color:var(--red)" onclick="sendAnno()">SEND</button>
                    </div>
                </div>

                <div class="panel-box" style="flex:1;">
                    <div class="panel-header" style="color:var(--cyan)">SUPPORT TICKETS</div>
                    <div id="supportBox" class="chat-area"></div>
                    <div class="chat-input-row">
                        <input id="repUser" class="chat-input" style="flex:0.4" placeholder="User">
                        <input id="repMsg" class="chat-input" placeholder="Reply...">
                        <button class="btn-small" onclick="sendReply()">REPLY</button>
                    </div>
                </div>

                <div class="panel-box" style="flex:1;">
                    <div class="panel-header" style="color:var(--gold)">PUBLIC CHAT</div>
                    <div id="publicBox" class="chat-area"></div>
                    <div class="chat-input-row">
                        <input id="pubMsg" class="chat-input" placeholder="Chat as Admin...">
                        <button class="btn-small" onclick="sendPub()">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myToken = localStorage.getItem('adminToken');
        const audio = document.getElementById('adminAudio');

        if(myToken) socket.emit('auth_handshake', { type: 'admin', token: myToken });

        async function performLogin() {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok) {
                    myToken = data.token;
                    localStorage.setItem('adminToken', myToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    socket.emit('auth_handshake', { type: 'admin', token: myToken });
                } else { document.getElementById('loginError').innerText = data.error; }
            } catch (e) { document.getElementById('loginError').innerText = "Connection Error"; }
        }

        function performLogout() {
            fetch('/api/admin/logout', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ token: myToken }) });
            localStorage.removeItem('adminToken');
            location.reload();
        }

        socket.on('auth_success', (data) => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('myIdentity').innerHTML = `${data.username} <span class="staff-badge badge-${data.role}">${data.role}</span>`;
            reqRefresh();
        });
        socket.on('auth_fail', () => { document.getElementById('loginScreen').style.display = 'flex'; localStorage.removeItem('adminToken'); });

        // STAFF
        function createStaff() {
            const u = document.getElementById('newStaffUser').value;
            const p = document.getElementById('newStaffPass').value;
            const r = document.getElementById('newStaffRole').value;
            if (u && p) {
                if(confirm(`Create ${r} account for user '${u}'?`)) {
                    socket.emit('admin_create_staff', { username: u, password: p, role: r });
                    document.getElementById('newStaffUser').value = '';
                    document.getElementById('newStaffPass').value = '';
                }
            } else { alert("Enter username/password"); }
        }
        socket.on('admin_log', (msg) => alert(msg));

        // CORE
        function reqRefresh() { socket.emit('admin_req_data'); }
        socket.on('active_players_update', (list) => {
            const staffDiv = document.getElementById('staffList'); staffDiv.innerHTML = '';
            list.forEach(u => { if(u.role === 'ADMIN' || u.role === 'MOD') staffDiv.innerHTML += `<div class="stat-row" style="color:white"><span class="status-dot online"></span> ${u.username} <span class="staff-badge badge-${u.role}">${u.role}</span></div>`; });
        });
        
        socket.on('admin_data_resp', (data) => {
            const tbody = document.getElementById('dbBody');
            const savedScroll = tbody.parentElement.scrollTop;
            let html = '';
            const users = Object.entries(data.users).sort(); 
            users.forEach(([username, uData]) => {
                const isOnline = Object.values(data.active).find(u => u.username === username);
                html += `<tr><td><div class="status-dot ${isOnline?'online':''}"></div> ${username}</td><td>PLAYER</td><td style="color:var(--gold); font-weight:bold;">${uData.balance}</td><td><button class="btn-small" onclick="modCred('${username}', 'add')">+</button> <button class="btn-small" onclick="modCred('${username}', 'sub')">-</button></td></tr>`;
            });
            tbody.innerHTML = html;
            tbody.parentElement.scrollTop = savedScroll;

            const sBox = document.getElementById('supportBox');
            const chatScroll = sBox.scrollTop;
            sBox.innerHTML = '';
            data.support.forEach(t => { 
                let content = "";
                if(t.user.startsWith("To ")) content = `<b style="color:var(--cyan)">YOU:</b> ${t.msg}`;
                else content = `<span style="color:var(--cyan); cursor:pointer;" onclick="document.getElementById('repUser').value='${t.user}'">${t.user}</span>: ${t.msg}`;
                sBox.innerHTML += `<div style="border-bottom:1px solid #333; padding:5px;">${content}</div>`; 
            });
            sBox.scrollTop = chatScroll;
        });

        // ACTIONS
        function modCred(u, type) { const amt = prompt(`${type.toUpperCase()} amount for ${u}:`); if(amt) { if(type === 'add') socket.emit('admin_add_credits', { username: u, amount: amt }); else socket.emit('admin_deduct_credits', { username: u, amount: amt }); } }
        function addAll() { const amt = prompt("GIFT ALL PLAYERS:"); if(amt) socket.emit('admin_add_all', amt); }
        function sendAnno() { const m = document.getElementById('annoInput').value; if(m) { socket.emit('admin_announce', m); document.getElementById('annoInput').value = ''; } }

        // MUSIC
        function updateMeta() { socket.emit('admin_update_metadata', { title: document.getElementById('mTitle').value, artist: document.getElementById('mArtist').value }); }
        function changeTrack() { socket.emit('admin_change_track', document.getElementById('mUrl').value); }
        function toggleMusic(play) { if(play) { audio.play(); socket.emit('admin_music_action', { action: 'play', seek: audio.currentTime }); } else { audio.pause(); socket.emit('admin_music_action', { action: 'pause', seek: audio.currentTime }); } }
        socket.on('music_sync', (data) => {
            updatePreview(data);
            if(data.url && audio.src !== data.url) audio.src = data.url;
            if(data.playing) audio.play().catch(()=>{}); else audio.pause();
            if(Math.abs(audio.currentTime - data.seek) > 2) audio.currentTime = data.seek;
        });
        socket.on('metadata_update', (data) => { updatePreview(data); });

        function updatePreview(data) {
            const titleEl = document.getElementById('musicTitle');
            const artistEl = document.getElementById('musicArtist');
            const titleText = data.title || "Waiting...";
            const artistText = data.artist || "";
            titleEl.innerText = titleText;
            artistEl.innerText = artistText;
            if(!artistText) artistEl.style.display = 'none'; else artistEl.style.display = 'block';
            if(titleText.length > 20) titleEl.className = "music-title marquee"; else titleEl.className = "music-title";
        }

        // CHAT
        function sendPub() { const m = document.getElementById('pubMsg').value; if(m) { socket.emit('admin_chat_public', m); document.getElementById('pubMsg').value=''; } }
        function sendReply() { const u = document.getElementById('repUser').value; const m = document.getElementById('repMsg').value; if(u && m) { socket.emit('admin_reply_support', { targetUser: u, msg: m }); document.getElementById('repMsg').value=''; } }

        socket.on('chat_broadcast', (data) => {
            if(data.type.includes('public')) {
                const box = document.getElementById('publicBox');
                const badge = data.role !== 'PLAYER' ? `<span class="staff-badge badge-${data.role}">${data.role}</span> ` : '';
                const color = data.role === 'ADMIN' ? 'var(--gold)' : (data.role === 'MOD' ? 'var(--cyan)' : '#fff');
                box.innerHTML += `<div>${badge}<b style="color:${color}">${data.user}:</b> ${data.msg}</div>`;
                box.scrollTop = box.scrollHeight;
            }
            if(data.type.includes('support')) reqRefresh(); // Reload support from DB data to avoid dupe logic
        });
    </script>
</body>
</html>