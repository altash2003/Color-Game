<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GRAND CASINO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Oswald:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --gold: #FFD700; --cyan: #00E5FF; --red: #d32f2f; --panel-bg: rgba(12,12,12,0.95); }
        body { margin: 0; overflow: hidden; height: 100vh; width: 100vw; background: #000; font-family: 'Rajdhani', sans-serif; user-select: none; color:white; touch-action:none; }
        * { -ms-overflow-style: none; scrollbar-width: none; box-sizing: border-box; }
        *::-webkit-scrollbar { display: none; }
        
        /* SECURITY: NO SELECT */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        .global-back { position: fixed; top: 15px; left: 15px; z-index: 9000; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-weight: bold; display: none; }
        
        #authOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: #111; padding: 40px; border: 1px solid #333; border-radius: 12px; text-align: center; width: 300px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; text-align: center; font-weight:bold; }
        .auth-btn { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; border-radius:4px; }

        /* --- PANELS FIXED LAYOUT --- */
        .side-panel { position: fixed; width: 300px; background: var(--panel-bg); border: 1px solid #444; display: none; flex-direction: column; z-index: 8000; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .side-panel.active { display: flex; }
        .panel-head { padding: 10px; font-weight: bold; font-size: 14px; background: rgba(255,255,255,0.05); border-bottom: 1px solid #333; color: #aaa; display: flex; justify-content: space-between; }
        .panel-tab { flex:1; text-align:center; cursor:pointer; color:#666; padding:5px; }
        .panel-tab.active { color:white; border-bottom:2px solid var(--gold); }
        .panel-list { overflow-y: auto; padding: 5px; flex: 1; }
        .panel-item { display: flex; justify-content: space-between; padding: 6px; border-bottom: 1px solid #222; font-size: 13px; align-items: center; }
        
        /* Left Column (Table Top to Mid, Mid to Bottom) */
        #playerPanel { top: 120px; left: 15px; height: 350px; border-left: 3px solid var(--cyan); }
        #chatPanel { top: 480px; left: 15px; height: 350px; border-left: 3px solid var(--gold); }
        
        /* Right Column */
        #betPanel { top: 120px; right: 15px; height: 350px; border-right: 3px solid var(--gold); }
        #voicePanel { top: 480px; right: 15px; height: 120px; border-right: 3px solid var(--cyan); }
        #musicPanel { top: 610px; right: 15px; height: 140px; border-right: 3px solid var(--cyan); }

        /* CHAT */
        .chat-tabs { display: flex; border-bottom: 1px solid #333; background: #111; }
        .chat-content { flex: 1; overflow-y: scroll; padding: 10px; display: none; font-size: 13px; }
        .chat-content.active { display: block; }
        .chat-input-area { padding: 10px; border-top: 1px solid #333; display: none; background: #1a1a1a; gap: 5px; }
        .chat-input-area.active { display: flex; }
        .chat-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 8px; outline:none; }

        /* MUSIC/VOICE */
        .vp-row { display: flex; justify-content: space-around; padding: 10px; }
        .vp-btn { background: #222; border: 1px solid #555; color: #888; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 10px; }
        .vp-btn.active { border-color: var(--gold); color: var(--gold); }
        .mp-controls { display:flex; gap:5px; padding:10px; }
        .mp-btn { flex:1; background: #333; border: 1px solid #555; color: white; padding: 8px; cursor: pointer; }

        /* CHIPS (EXACT CLONES) */
        .chips-bar { display: flex; gap: 10px; padding: 8px 20px; background: rgba(0,0,0,0.5); border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); align-items:center; width: fit-content; margin: 0 auto; pointer-events: auto; }
        .chip { width: 45px; height: 45px; border-radius: 50%; position: relative; cursor: pointer; transition: transform 0.15s; box-shadow: 0 4px 8px rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .chip.active { transform: scale(1.15) translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.8); }
        .chip::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: repeating-conic-gradient(var(--c1) 0deg 15deg, var(--c2) 15deg 30deg, var(--c1) 30deg 45deg, var(--c3) 45deg 60deg); }
        .chip::after { content: ''; position: absolute; inset: 4px; border-radius: 50%; background: var(--c1); border: 1px solid rgba(0,0,0,0.3); z-index: 2; }
        /* CENTERED TEXT & UPPERCASE */
        .chip-label { position: relative; z-index: 10; width: 22px; height: 22px; background: #fdfbf7; border-radius: 50%; border: 1px solid #d4d4d4; color: #333; font-size: 9px; font-weight: 900; text-transform:uppercase; display:flex; justify-content:center; align-items:center; }
        
        .chip-50 { --c1: #e0dfd5; --c2: #fff; --c3: #b0b0a8; }
        .chip-200 { --c1: #6b1818; --c2: #a32e2e; --c3: #3b0505; }
        .chip-1k { --c1: #1e4d2b; --c2: #367a48; --c3: #0d2613; }
        .chip-10k { --c1: #142850; --c2: #2c4d87; --c3: #050e21; }
        .chip-100k { --c1: #262626; --c2: #444; --c3: #000; }
        
        .chip.chip-board { width: 36px; height: 36px; pointer-events: none; z-index: 200; position: absolute; box-shadow: 0 4px 8px rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; }
        .chip.chip-board::after { inset: 4px; } 
        .chip.chip-board .chip-label { width: 18px; height: 18px; font-size: 8px; }

        /* LOBBY */
        #view-lobby { background: url('background.jpg') center/cover; flex-direction: column; justify-content: center; align-items: center; gap: 30px; }
        .game-card { width: 260px; height: 360px; background: rgba(0,0,0,0.85); border: 2px solid #333; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .game-card:hover { border-color: var(--gold); transform: translateY(-10px); }

        /* ROULETTE */
        #view-roulette { background: url('background.jpg') center/cover; }
        .r-center { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100vw; transition: filter 0.3s; }
        .r-center.blur { filter: blur(8px); pointer-events: none; }
        .r-scaler { transform: scale(1.65); transform-origin: center center; margin-top: 20px; } 
        .r-board { position: relative; background-color: #01431E; padding: 15px; border-radius: 16px; border: 10px solid #002b12; box-shadow: 0 0 0 5px var(--gold), 0 20px 50px black; width: fit-content; display: flex; flex-direction: column; align-items: center; }
        
        /* HUD FIXED TOP CENTERED */
        .r-hud { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; z-index: 9000; }
        .r-hud-panel { background: rgba(0,0,0,0.85); padding: 5px 20px; border-radius: 20px; border: 1px solid #444; text-align: center; box-shadow: 0 5px 15px black; height:60px; display:flex; flex-direction:column; justify-content:center; }
        /* FIXED WIDTHS AS REQUESTED */
        .r-hud-panel.bal, .r-hud-panel.status { width: 250px; } 
        .r-hud-panel.timer { width: 100px; border: 1px solid var(--gold); }
        .r-hud-lbl { font-size: 10px; color: #888; letter-spacing: 2px; }
        .r-hud-val { font-size: 28px; font-weight: bold; color: white; font-family: 'Oswald'; }

        /* History */
        .r-history { width: 628px; height: 32px; background: rgba(0,0,0,0.4); border-radius: 4px; display: flex; align-items: center; padding: 0 2px; gap: 4px; margin-bottom: 8px; overflow: hidden; justify-content: center; border: none; }
        .hist-ball { width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 10px; box-shadow: 0 2px 4px black; color: white; flex-shrink: 0; }
        .hist-red { background: #d32f2f; } .hist-black { background: #222; } .hist-green { background: #016D29; } 
        .hist-empty { background: rgba(255,255,255,0.05); }

        /* Grid */
        .r-grid { display: grid; grid-template-columns: 50px repeat(12, 42px) 34px; grid-template-rows: repeat(3, 42px) 42px 42px; gap: 2px; padding: 5px; border: 2px solid var(--gold); border-radius: 6px; background: rgba(0,0,0,0.2); position: relative; width: fit-content; }
        .cell { display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; cursor: pointer; border: 2px solid var(--gold); color: white; position: relative; z-index: 5; }
        .cell.lit { background: rgba(255,255,255,0.3); } 
        .red-cell { background-color: #d32f2f; } .black-cell { background-color: #222; }
        .zone-0 { grid-column: 1; grid-row: 1 / 4; background-color: #016D29; border-radius: 6px 0 0 6px; }
        
        .hotspot-overlay { position: absolute; inset: 0; z-index: 60; pointer-events: none; }
        /* INVISIBLE CLICKABLE ZONES */
        .hotspot { position: absolute; cursor: pointer; pointer-events: auto; z-index: 60; background: transparent; }
        .hotspot:hover { background: rgba(255,255,255,0.1); }

        /* Controls Area */
        .r-controls-area { width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 10px; gap: 10px; z-index: 200; position:relative; }
        .btn-row { display: flex; gap: 10px; }
        /* High Z-Index for Buttons */
        .ctrl-btn { background: #111; border: 1px solid #444; color: #ccc; padding: 6px 15px; font-size: 11px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; pointer-events: auto; z-index: 201; position:relative; }
        .ctrl-btn:hover { background: #222; color: white; border-color: var(--gold); }

        /* BUTTONS (LOWER LEFT) */
        .icon-controls { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 15px; z-index: 9000; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; background: #222; border: 1px solid #555; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; color: #ccc; transition: 0.2s; }
        .icon-btn:hover { color: white; border-color: var(--gold); }
        
        /* Mute Button (Static Icon Top Right) */
        #muteBtn { position: absolute; top: 15px; right: 20px; z-index: 9000; cursor: pointer; color: #888; font-size: 24px; transition:0.2s; }
        #muteBtn:hover { color:white; }

        /* Wheel */
        #wheel-overlay { position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center; pointer-events: none; transition: opacity 0.5s; opacity: 0; }
        #wheel-overlay.show { display: flex; opacity: 1; }
        .wheelPanel { filter: drop-shadow(0 20px 50px rgba(0,0,0,0.8)); }

        /* WINNING ANIMATION STAGE */
        #win-overlay-stage { position: fixed; inset: 0; z-index: 8000; display: none; align-items: center; justify-content: center; pointer-events: none; opacity:0; transition: opacity 0.5s; }
        #win-overlay-stage.active { display: flex; opacity: 1; }
        .winning-line { display: flex; gap: 15px; padding: 20px; background: rgba(0,0,0,0.8); border-radius: 20px; border: 2px solid #FFD700; transform: scale(1.5); align-items:center; flex-wrap: wrap; justify-content: center; max-width: 80%; }
        /* Style clones exactly like table cells but bigger */
        .win-cell-clone { width: 60px; height: 40px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; border: 2px solid gold; border-radius: 6px; position: relative; background: #222; box-shadow: 0 0 10px gold; font-family:'Oswald'; font-size: 14px; text-transform:uppercase; }
        .win-cell-clone.red { background: #d32f2f; } .win-cell-clone.black { background: #111; } .win-cell-clone.green { background: #016D29; }
        .win-amt-tag { position: absolute; top: -20px; background: #FFD700; color: black; font-size: 12px; font-weight: 900; padding: 2px 5px; border-radius: 4px; white-space: nowrap; box-shadow: 0 2px 5px black; z-index: 10; left:50%; transform:translateX(-50%); }
        .flying-coin { position: fixed; width: 40px; height: 40px; background: gold; border-radius: 50%; border: 3px solid orange; box-shadow: 0 0 15px yellow; z-index: 10000; display: flex; justify-content: center; align-items: center; font-weight: bold; color: black; font-size: 10px; transition: all 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:var(--gold)">GRAND CASINO</h1>
            <input id="u" class="auth-input" placeholder="USERNAME" maxlength="12">
            <input id="p" class="auth-input" type="password" placeholder="PASSWORD" maxlength="12">
            <button onclick="login()" class="auth-btn">ENTER</button>
            <button onclick="register()" class="auth-btn" style="background:transparent; border:1px solid #555; color:#aaa; font-size:12px;">REGISTER</button>
            <div id="authErr" style="color:red; font-size:12px; margin-top:5px;"></div>
        </div>
    </div>

    <i class="fa fa-volume-up" id="muteBtn" onclick="toggleMasterMute()"></i>

    <div class="r-hud" id="topHud">
        <div class="r-hud-panel bal"><div class="r-hud-lbl">BALANCE</div><div class="r-hud-val" id="hud-bal" style="color:var(--cyan)">0</div></div>
        <div class="r-hud-panel timer"><div class="r-hud-lbl">TIMER</div><div class="r-hud-val" id="hud-timer" style="color:var(--gold)">--</div></div>
        <div class="r-hud-panel status"><div class="r-hud-lbl">STATUS</div><div class="r-hud-val" id="hud-status" style="font-size:18px;">LOBBY</div></div>
    </div>

    <div id="playerPanel" class="side-panel">
        <div class="panel-head">
            <div class="panel-tab active" onclick="tabPlayer('players')">PLAYERS</div>
            <div class="panel-tab" onclick="tabPlayer('staff')">STAFF</div>
        </div>
        <div class="panel-list" id="pList"></div>
    </div>
    
    <div id="chatPanel" class="side-panel">
        <div class="panel-head">
            <div class="panel-tab active" onclick="tabChat('public')">PUBLIC</div>
            <div class="panel-tab" onclick="tabChat('support')">SUPPORT</div>
        </div>
        <div class="chat-content active" id="content-public"></div><div class="chat-content" id="content-support"></div>
        <div class="chat-input-area"><input id="chatIn" class="chat-input" placeholder="Type..."><button onclick="sendChat('public')" style="background:var(--gold); border:none; padding:0 10px;">></button></div>
    </div>

    <div id="betPanel" class="side-panel"><div class="panel-head"><div style="flex:1; text-align:center;">CURRENT BETS</div></div><div class="panel-list" id="bList"></div><div style="padding:10px; font-size:12px; text-align:right; color:var(--gold); border-top:1px solid #333;">TOTAL: <span id="bTotal">0</span></div></div>

    <div id="voicePanel" class="side-panel">
        <div class="panel-head"><div style="flex:1; text-align:center;">VOICE SETTINGS</div></div>
        <div class="vp-row"><button class="vp-btn" id="v-off" onclick="setVoice('off')">OFF</button><button class="vp-btn" id="v-ptt" onclick="setVoice('ptt')">PTT</button><button class="vp-btn" id="v-auto" onclick="setVoice('auto')">AUTO</button></div>
    </div>

    <div id="musicPanel" class="side-panel">
        <div class="panel-head"><div style="flex:1; text-align:center;">CASINO DJ</div></div>
        <div class="mp-controls"><button class="mp-btn" onclick="toggleMusic()">PLAY/PAUSE</button><button class="mp-btn" onclick="stopMusic()">STOP</button></div>
        <div style="padding:0 10px;"><input type="range" class="vol-slider" min="0" max="100" value="20" onchange="setVolume(this.value)"></div>
    </div>

    <button class="global-back" id="backBtn" onclick="lobby()">‚Üê LOBBY</button>

    <div id="view-lobby" class="view-section active">
        <h1 style="font-size:80px; color:var(--gold); margin-bottom:20px;">GRAND CASINO</h1>
        <div style="margin-bottom:30px; font-size:20px;"><span id="lobbyUser" style="color:var(--gold)">Guest</span> | <span id="lobbyBal" style="color:var(--cyan)">0</span></div>
        <div style="display:flex; gap:40px;">
            <div class="game-card" onclick="enter('colorgame')"><div style="font-size:50px">üé®</div><h2 style="color:#ccc;">COLOR</h2></div>
            <div class="game-card" onclick="enter('roulette')"><div style="font-size:50px">üé°</div><h2 style="color:#ccc;">ROULETTE</h2></div>
        </div>
    </div>

    <div id="view-colorgame" class="view-section"><div style="text-align:center; padding-top:50px;"><h1 style="color:white;">COLOR GAME</h1></div></div>

    <div id="view-roulette" class="view-section">
        <div id="wheel-overlay"><div class="wheelPanel"><canvas id="wheelCanvas" width="800" height="800"></canvas></div></div>
        
        <div class="r-center" id="rContainer">
            <div class="r-scaler">
                <div class="r-board">
                    <div class="r-history" id="rHistory"></div>
                    <div class="r-grid" id="rGrid">
                        <div class="hotspot-overlay" id="hotspotOverlay"></div>
                        <div style="position:absolute; inset:0; z-index:55; pointer-events:none;" id="rOverlay"></div>
                        <div class="cell zone-0" id="cell-0">0</div>
                    </div>
                    <div class="r-controls-area">
                        <div class="btn-row">
                            <div class="ctrl-btn" onclick="sendUndo()">UNDO</div>
                            <div class="ctrl-btn" onclick="sendClear()">CLEAR</div>
                            <div class="ctrl-btn" onclick="sendRebet()">REBET</div>
                            <div class="ctrl-btn" onclick="sendDouble()">DOUBLE</div>
                        </div>
                        <div class="chips-bar">
                            <div class="chip chip-50 active" onclick="setChip(50, this)"><div class="chip-label">50</div></div>
                            <div class="chip chip-200" onclick="setChip(200, this)"><div class="chip-label">200</div></div>
                            <div class="chip chip-1k" onclick="setChip(1000, this)"><div class="chip-label">1K</div></div>
                            <div class="chip chip-10k" onclick="setChip(10000, this)"><div class="chip-label">10K</div></div>
                            <div class="chip chip-100k" onclick="setChip(100000, this)"><div class="chip-label">100K</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="icon-controls">
                <div class="icon-btn" onclick="togglePanel('chatPanel')"><i class="fa fa-comment"></i></div>
                <div class="icon-btn" onclick="togglePanel('voicePanel')"><i class="fa fa-microphone"></i></div>
                <div class="icon-btn" onclick="togglePanel('musicPanel')"><i class="fa fa-music"></i></div>
            </div>
        </div>
        
        <div id="win-overlay-stage"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // SECURITY
        document.addEventListener('contextmenu', e=>e.preventDefault());
        document.onkeydown = (e) => { if(e.keyCode==123 || (e.ctrlKey && e.shiftKey && e.keyCode==73)) return false; };

        const socket = io();
        let me="", bal=0, room="lobby", chip=50;
        let isRolling=false, bets=[], lastBets=[];
        let boardChips = {}; 
        const SCALE = 1.65; const REDS=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

        function login(){ socket.emit('login', {username:document.getElementById('u').value, password:document.getElementById('p').value}); }
        function register(){ socket.emit('register', {username:document.getElementById('u').value, password:document.getElementById('p').value}); }
        socket.on('login_success', d=>{ me=d.username; bal=d.balance; document.getElementById('authOverlay').style.display='none'; upd(); });
        socket.on('update_balance', b=>{ bal=b; upd(); });
        function upd(){ ['lobbyBal','hud-bal'].forEach(id=>{ if(document.getElementById(id))document.getElementById(id).innerText=bal.toLocaleString(); }); document.getElementById('lobbyUser').innerText=me; }

        function enter(r) { 
            room=r; socket.emit('switch_room', r);
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+r).classList.add('active');
            ['playerPanel','betPanel','chatPanel','backBtn','topHud'].forEach(i=>{let e=document.getElementById(i); if(e)e.style.display='flex';});
            if(r==='roulette') initR();
            initAudio();
        }
        function lobby() {
            room='lobby'; socket.emit('switch_room', 'lobby');
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-lobby').classList.add('active');
            ['playerPanel','betPanel','backBtn','chatPanel','musicPanel','voicePanel','topHud'].forEach(i=>document.getElementById(i).style.display='none');
        }

        function togglePanel(id) { let p=document.getElementById(id); p.style.display = (p.style.display==='flex') ? 'none' : 'flex'; }
        let muted=false; function toggleMasterMute(){ muted=!muted; document.getElementById('muteIcon').className = muted ? 'fa fa-volume-off' : 'fa fa-volume-up'; audio.muted=muted; }

        function setChip(v, el) { chip=v; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); if(el)el.classList.add('active'); }
        function placeChip(nums, desc, mx, my) {
            if(isRolling) return alert("BETS LOCKED");
            if(bal<chip) return alert("Funds");
            
            let overlay = document.getElementById('rOverlay').getBoundingClientRect();
            let relX = (mx - overlay.left) / SCALE; 
            let relY = (my - overlay.top) / SCALE;
            let key = desc + "_" + nums.sort().join('_');

            if(boardChips[key]) {
                boardChips[key].amt += chip;
                updateChipVisual(boardChips[key]);
            } else {
                let d = document.createElement('div');
                document.getElementById('rOverlay').appendChild(d);
                boardChips[key] = { amt: chip, dom: d, nums: nums, desc: desc, relX: relX, relY: relY, key: key };
                updateChipVisual(boardChips[key]);
            }
            socket.emit('place_bet_roulette', {numbers:nums, amount:chip});
            renderBetList();
        }

        function updateChipVisual(c) {
            c.dom.className = `chip chip-board ${getChipClass(c.amt)}`;
            c.dom.innerHTML = `<div class="chip-label">${formatChip(c.amt)}</div>`;
            c.dom.style.left = c.relX + 'px';
            c.dom.style.top = c.relY + 'px';
            c.dom.style.transform = 'translate(-50%, -50%)'; 
        }

        function getChipClass(a) { if(a<200)return 'chip-50'; if(a<1000)return 'chip-200'; if(a<10000)return 'chip-1k'; if(a<100000)return 'chip-10k'; return 'chip-100k'; }
        function formatChip(v) { if(v>=1000 && v<1000000) return (v/1000)+'K'; if(v>=1000000) return (v/1000000)+'M'; return v; }

        function renderBetList() {
            let list = document.getElementById('bList'); list.innerHTML='';
            let total = 0;
            let agg = {};
            for(let k in boardChips) {
                let b = boardChips[k];
                let lbl = b.desc;
                if(b.desc.includes("Straight")) lbl=`Single (${b.nums[0]})`;
                else if(b.desc.includes("Split")) lbl=`Split (${b.nums.join(',')})`;
                else if(b.desc.includes("Corner")) lbl=`Corner (${b.nums.join(',')})`;
                else if(b.desc.includes("Street")) lbl=`Street (${Math.min(...b.nums)}-${Math.max(...b.nums)})`;
                else if(b.desc.includes("Six Line")) lbl=`Six Lines (${Math.min(...b.nums)}-${Math.max(...b.nums)})`;
                if(!agg[lbl]) agg[lbl] = 0;
                agg[lbl] += b.amt;
                total += b.amt;
            }
            for(let d in agg) { list.innerHTML += `<div class="panel-item"><span>${d}</span><span style="color:var(--gold)">${agg[d]}</span></div>`; }
            document.getElementById('bTotal').innerText = total;
        }

        function sendClear() { 
            if(isRolling) return;
            socket.emit('roulette_clear'); 
        }
        socket.on('bets_cleared', ()=>{
            for(let k in boardChips) boardChips[k].dom.remove();
            boardChips={}; 
            renderBetList(); 
        });

        function sendUndo() {
            if(isRolling) return;
            let keys = Object.keys(boardChips);
            if(keys.length > 0) {
                let lastKey = keys[keys.length-1];
                let b = boardChips[lastKey];
                socket.emit('place_bet_roulette', {numbers:b.nums, amount: -b.amt}); 
                b.dom.remove();
                delete boardChips[lastKey];
                renderBetList();
            }
        }
        function sendRebet() { 
            if(isRolling || Object.keys(lastBets).length === 0) return;
            for(let k in lastBets) {
                let old = lastBets[k];
                if(bal >= old.amt) {
                    let d = document.createElement('div');
                    document.getElementById('rOverlay').appendChild(d);
                    boardChips[k] = { ...old, dom: d };
                    updateChipVisual(boardChips[k]);
                    socket.emit('place_bet_roulette', {numbers:old.nums, amount:old.amt});
                }
            }
            renderBetList();
        }
        function sendDouble() {
            if(isRolling) return;
            for(let k in boardChips) {
                let b = boardChips[k];
                if(bal >= b.amt) {
                    let add = b.amt;
                    b.amt += add;
                    updateChipVisual(b);
                    socket.emit('place_bet_roulette', {numbers:b.nums, amount:add});
                }
            }
            renderBetList();
        }

        socket.on('roulette_spin_start', n=>{ 
            isRolling=true; lastBets=JSON.parse(JSON.stringify(boardChips, (key, value) => key === 'dom' ? undefined : value)); 
            document.getElementById('wheel-overlay').classList.add('show'); spin(n); 
        });
        socket.on('roulette_new_round', ()=>{ 
            isRolling=false; 
            for(let k in boardChips) boardChips[k].dom.remove(); boardChips={}; renderBetList();
            document.getElementById('hud-status').innerText="BETTING"; 
            document.getElementById('rContainer').classList.remove('blur'); 
            document.getElementById('win-overlay-stage').classList.remove('active'); 
        });
        socket.on('roulette_timer', t=>{ document.getElementById('hud-timer').innerText=t; });
        socket.on('roulette_state', s=>{ document.getElementById('hud-status').innerText=s; if(s==='LOCKED'||s==='CLOSED') isRolling = true; });

        function initR() {
            if(document.getElementById('cell-1')) return;
            let g = document.getElementById('rGrid');
            for(let i=1; i<=36; i++) {
                let r=(i%3===0)?1:(i%3===2?2:3); let c=Math.floor((i-1)/3)+2;
                let cls=REDS.includes(i)?'red-cell':'black-cell';
                let d=document.createElement('div'); d.className=`cell ${cls}`; d.id=`cell-${i}`; d.innerText=i; d.style.gridRow=r; d.style.gridColumn=c;
                d.onclick=(e)=>{ let r=e.target.getBoundingClientRect(); placeChip([i], "Straight "+i, r.left+r.width/2, r.top+r.height/2); };
                g.appendChild(d);
            }
            const add = (id, txt, r, c, sr, sc, cls='') => {
                let d = document.createElement('div'); d.id=id; d.innerText=txt; d.className=`cell ${cls}`; 
                d.style.gridRow=`${r} / span ${sr}`; d.style.gridColumn=`${c} / span ${sc}`;
                if(id.includes('row')) d.style.writingMode='vertical-rl';
                g.appendChild(d);
            };
            add('btn-row1','2to1',1,14,1,1); add('btn-row2','2to1',2,14,1,1); add('btn-row3','2to1',3,14,1,1);
            add('btn-doz1','1st 12',4,2,1,4); add('btn-doz2','2nd 12',4,6,1,4); add('btn-doz3','3rd 12',4,10,1,4);
            add('btn-low','1-18',5,2,1,2); add('btn-even','EVEN',5,4,1,2); 
            add('btn-red','RED',5,6,1,2,'red-cell'); add('btn-black','BLACK',5,8,1,2,'black-cell');
            add('btn-odd','ODD',5,10,1,2); add('btn-high','19-36',5,12,1,2);
            initHistory(); buildHotspots(); drawWheel(0);
        }

        function buildHotspots() {
            const overlay = document.getElementById('hotspotOverlay'); overlay.innerHTML='';
            const W=42, H=42, GAP=2, OX=55+GAP, OY=5;
            for(let c=0; c<12; c++) {
                let x = OX + (c*(W+GAP));
                let nT=(c*3)+3, nM=(c*3)+2, nB=(c*3)+1;
                mkZone(x+5, OY+H-5, W-10, 10, [nT,nM], "Split "+nT+","+nM); mkZone(x+5, OY+(H*2)+GAP-5, W-10, 10, [nM,nB], "Split "+nM+","+nB);
                mkZone(x+5, OY-5, W-10, 10, [nT,nM,nB], "Street "+nB);
                if(c<11) {
                    mkZone(x+W-5, OY+5, 10, H-10, [nT,nT+3], "Split "+nT+","+ (nT+3)); mkZone(x+W-5, OY+H+GAP+5, 10, H-10, [nM,nM+3], "Split "+nM+","+ (nM+3)); mkZone(x+W-5, OY+(H+GAP)*2+5, 10, H-10, [nB,nB+3], "Split "+nB+","+ (nB+3));
                    mkZone(x+W-5, OY+H-5, 10, 10, [nT,nM,nT+3,nM+3], "Corner", [nT,nM,nT+3,nM+3]); mkZone(x+W-5, OY+(H*2)+GAP-5, 10, 10, [nM,nB,nM+3,nB+3], "Corner", [nM,nB,nM+3,nB+3]);
                    mkZone(x+W-5, OY-5, 10, 10, [nT,nM,nB,nT+3,nM+3,nB+3], "Six Line", [nT,nM,nB,nT+3,nM+3,nB+3]);
                }
            }
            mkZone(5, 5, 50, (H+GAP)*3, [0], "Straight 0");
            
            const bind = (id, nums, desc) => {
                let el = document.getElementById(id);
                if(el) mkZone(el.offsetLeft, el.offsetTop, el.offsetWidth, el.offsetHeight, nums, desc);
            };
            const range = (s,e)=>Array.from({length:e-s+1},(_,i)=>s+i);
            setTimeout(() => {
                bind('btn-red', REDS, 'RED'); bind('btn-black', range(1,36).filter(x=>!REDS.includes(x)), 'BLACK');
                bind('btn-even', range(1,36).filter(x=>x%2==0), 'EVEN'); bind('btn-odd', range(1,36).filter(x=>x%2!=0), 'ODD');
                bind('btn-low', range(1,18), '1-18'); bind('btn-high', range(19,36), '19-36');
                bind('btn-doz1', range(1,12), '1st 12'); bind('btn-doz2', range(13,24), '2nd 12'); bind('btn-doz3', range(25,36), '3rd 12');
                bind('btn-row1', range(3,36,3), 'Row 1'); bind('btn-row2', range(2,36,3), 'Row 2'); bind('btn-row3', range(1,36,3), 'Row 3');
            }, 100);
        }

        function mkZone(x,y,w,h,n,desc, hlNums){ 
            let d=document.createElement('div'); d.className='hotspot'; 
            d.style.left=x+'px'; d.style.top=y+'px'; d.style.width=w+'px'; d.style.height=h+'px'; 
            d.onclick=(e)=>{ let r=d.getBoundingClientRect(); placeChip(n, desc, r.left+r.width/2, r.top+r.height/2); };
            d.onmouseenter=()=>{ hlNums.forEach(num=>{ let c=document.getElementById('cell-'+num); if(c)c.classList.add('lit'); }); };
            d.onmouseleave=()=>{ hlNums.forEach(num=>{ let c=document.getElementById('cell-'+num); if(c)c.classList.remove('lit'); }); };
            document.getElementById('hotspotOverlay').appendChild(d); 
        }

        function initHistory() {
            let h = document.getElementById('rHistory'); h.innerHTML='';
            for(let i=0; i<20; i++) { 
                let b=document.createElement('div'); let c = ['hist-red','hist-black'][Math.floor(Math.random()*2)];
                b.className=`hist-ball ${c}`; b.style.opacity='0.1'; b.innerText='?'; h.appendChild(b); 
            }
        }
        function createBall(cls, txt) { let b=document.createElement('div'); b.className=`hist-ball ${cls}`; b.innerText=txt; return b; }
        socket.on('roulette_result_log', n=>{
            let h=document.getElementById('rHistory');
            if(h.children.length>=20) h.removeChild(h.lastChild);
            let c = n===0?'hist-green':(REDS.includes(n)?'hist-red':'hist-black');
            h.prepend(createBall(c, n));
        });

        socket.on('roulette_win', d=>{ 
            document.getElementById('wheel-overlay').classList.remove('show');
            let n = d.number;
            setTimeout(() => {
                document.getElementById('rContainer').classList.add('blur');
                let stage = document.getElementById('win-overlay-stage');
                stage.classList.add('active');
                
                let html = `<div class="winning-line">`;
                let wins = [];
                wins.push({txt:n, cls:REDS.includes(n)?'red-cell':'black-cell'}); // Number
                if(n!=0) {
                    wins.push({txt:n%2==0?'EVEN':'ODD', cls:'black-cell'});
                    wins.push({txt:REDS.includes(n)?'RED':'BLACK', cls:REDS.includes(n)?'red-cell':'black-cell'});
                    wins.push({txt:n<=18?'1-18':'19-36', cls:'black-cell'});
                    if(n<=12) wins.push({txt:'1st 12', cls:'black-cell'}); else if(n<=24) wins.push({txt:'2nd 12', cls:'black-cell'}); else wins.push({txt:'3rd 12', cls:'black-cell'});
                    if(n%3==0) wins.push({txt:'Row 1', cls:'black-cell'}); else if(n%3==2) wins.push({txt:'Row 2', cls:'black-cell'}); else wins.push({txt:'Row 3', cls:'black-cell'});
                }
                
                let totalWin = 0;
                for(let k in boardChips) {
                    let b = boardChips[k];
                    if(b.nums.includes(n)) {
                        let multiplier = 36/b.nums.length;
                        let win = b.amt * multiplier;
                        totalWin += win;
                        wins.forEach(w => { if(w.txt == b.desc || (b.desc.includes('Row') && w.txt.includes('Row'))) w.amt = win; });
                    }
                }

                wins.forEach(w => {
                    let amtTag = w.amt ? `<div class="win-amt-tag">+${w.amt}</div>` : '';
                    html += `<div class="win-cell-clone ${w.cls}">${w.txt}${amtTag}</div>`;
                });
                html += `</div>`;
                stage.innerHTML = html;

                if(totalWin > 0) {
                    setTimeout(() => {
                        let coin = document.createElement('div'); coin.className = 'flying-coin'; coin.innerText = '+'+totalWin;
                        coin.style.left = '50%'; coin.style.top = '50%'; document.body.appendChild(coin);
                        let balRect = document.getElementById('hud-bal').getBoundingClientRect();
                        setTimeout(()=>{ coin.style.left = balRect.left + 'px'; coin.style.top = balRect.top + 'px'; coin.style.opacity = '0'; }, 500);
                        setTimeout(()=>{ coin.remove(); }, 1500);
                    }, 1000);
                }
            }, 500); 
        });

        // WHEEL (Same)
        const cvs=document.getElementById('wheelCanvas'); const ctx=cvs.getContext('2d');
        const WHEEL=["0","32","15","19","4","21","2","25","17","34","6","27","13","36","11","30","8","23","10","5","24","16","33","1","20","14","31","9","22","18","29","7","28","12","35","3","26"];
        function drawWheel(a){ ctx.clearRect(0,0,800,800); ctx.save(); ctx.translate(400,400); ctx.rotate(a); WHEEL.forEach((n,i)=>{ ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,320,i*(Math.PI*2/37),(i+1)*(Math.PI*2/37)); ctx.fillStyle=n=="0"?'#016D29':(REDS.includes(parseInt(n))?'#b00':'#111'); ctx.fill(); ctx.stroke(); ctx.save(); ctx.rotate(i*(Math.PI*2/37)+(Math.PI/37)); ctx.fillStyle="#fff"; ctx.font="bold 24px Arial"; ctx.fillText(n,250,10); ctx.restore(); }); ctx.restore(); }
        function spin(n) { let idx=WHEEL.indexOf(n.toString()), dest=(Math.PI*2*5)-(idx*(Math.PI*2/37))-(Math.PI/37); function ani(ts){if(!s)s=ts; let p=(ts-s)/5000; if(p>1)p=1; drawWheel(dest*(1-Math.pow(1-p,3))); if(p<1)requestAnimationFrame(ani); else setTimeout(()=>document.getElementById('wheel-overlay').classList.remove('show'),2000);} let s; requestAnimationFrame(ani); }
    </script>
</body>
</html>
