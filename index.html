<!DOCTYPE html>
<html>
<head>
    <title>Fantasy Color Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --gold: #FFD700; --cyan: #00E5FF; --border: rgba(255,255,255,0.15); }
        body { font-family: 'Rajdhani', sans-serif; margin:0; background: url('background.jpg') center/cover; height: 100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; color:white; text-align:center; }
        
        #authOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: url('background.jpg') center/cover; z-index:3000; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(10px); }
        .auth-box { background: rgba(0,0,0,0.85); padding: 40px; border-radius: 16px; border: 1px solid var(--border); width: 320px; }
        .auth-input { width:100%; padding:12px; margin-bottom:10px; background:rgba(255,255,255,0.1); border:1px solid var(--border); color:white; text-align:center; border-radius:6px; box-sizing:border-box; }
        .auth-btn { width:100%; padding:12px; background:var(--gold); border:none; font-weight:bold; cursor:pointer; border-radius:6px; margin-top:5px; }
        .link { font-size:12px; color:#aaa; margin-top:15px; cursor:pointer; text-decoration:underline; }

        .main-container { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; width: 95%; height: 90vh; max-width: 1600px; }
        .side-panel { background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .game-wrapper { background: rgba(15,20,25,0.6); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        .hud-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .music-pill { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--border); }
        
        .bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; padding: 20px; }
        .bet-card { height: 100px; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: 0.1s; }
        .bet-card:active { transform: scale(0.95); }
        .bg-RED { background: #d32f2f; } .bg-GREEN { background: #388e3c; } .bg-BLUE { background: #1976d2; } 
        .bg-PINK { background: #c2185b; } .bg-WHITE { background: #f5f5f5; } .bg-YELLOW { background: #fbc02d; }

        .chat-msg { padding: 5px 10px; font-size: 14px; text-align: left; }
        
        @media (max-width: 768px) { .main-container { display:flex; flex-direction:column; width:100%; height:100vh; gap:0; } .side-panel { display:none; } }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div id="boxLogin" class="auth-box">
            <h1 style="color:var(--gold);">LOGIN</h1>
            <input type="text" id="lUser" class="auth-input" placeholder="USERNAME">
            <input type="password" id="lPass" class="auth-input" placeholder="PASSWORD">
            <button onclick="doLogin()" class="auth-btn">ENTER</button>
            <div class="link" onclick="toggleAuth()">Create Account</div>
            <div id="lErr" style="color:red; margin-top:10px;"></div>
        </div>
        <div id="boxReg" class="auth-box" style="display:none;">
            <h1 style="color:var(--cyan);">REGISTER</h1>
            <input type="text" id="rUser" class="auth-input" placeholder="NEW USERNAME">
            <input type="password" id="rPass" class="auth-input" placeholder="NEW PASSWORD">
            <button onclick="doReg()" class="auth-btn" style="background:var(--cyan);">CREATE</button>
            <div class="link" onclick="toggleAuth()">Back to Login</div>
            <div id="rErr" style="color:red; margin-top:10px;"></div>
        </div>
    </div>

    <div class="main-container" id="gameUI" style="display:none;">
        <div class="side-panel">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; color:var(--gold);">PLAYERS</div>
            <div id="pList" style="flex:1; overflow-y:auto; text-align:left;"></div>
        </div>

        <div class="game-wrapper">
            <div class="hud-header">
                <div><div style="font-size:10px; color:#aaa;">PLAYER</div><div id="dUser" style="font-weight:700;">GUEST</div></div>
                <div class="music-pill">
                    <i class="fas fa-music" style="color:var(--gold);"></i>
                    <div style="text-align:left;"><div id="mTitle" style="font-weight:bold; font-size:12px;">Waiting...</div><div id="mArtist" style="font-size:10px; color:var(--gold);"></div></div>
                </div>
                <div><div style="font-size:10px; color:#aaa;">CREDITS</div><div id="dBal" style="font-size:20px; font-weight:800; color:var(--gold);">0</div></div>
            </div>
            
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div id="gStatus" style="font-size:24px; color:#aaa; letter-spacing:3px;">BETS OPEN</div>
                <div id="gTimer" style="font-size:80px; font-weight:800;">20</div>
                <div style="display:flex; gap:20px; margin-top:20px;">
                    <div id="d1" style="width:60px; height:60px; background:#333; border-radius:10px;"></div>
                    <div id="d2" style="width:60px; height:60px; background:#333; border-radius:10px;"></div>
                    <div id="d3" style="width:60px; height:60px; background:#333; border-radius:10px;"></div>
                </div>
            </div>

            <div style="padding:10px; border-top:1px solid var(--border);">
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
                    <button class="auth-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="selChip(50)">50</button>
                    <button class="auth-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="selChip(100)">100</button>
                    <button class="auth-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="selChip(1000)">1K</button>
                    <button class="auth-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="selChip(10000)">10K</button>
                </div>
                <div class="bet-grid">
                    <div class="bet-card bg-RED" onclick="place('RED')"></div>
                    <div class="bet-card bg-GREEN" onclick="place('GREEN')"></div>
                    <div class="bet-card bg-BLUE" onclick="place('BLUE')"></div>
                    <div class="bet-card bg-PINK" onclick="place('PINK')"></div>
                    <div class="bet-card bg-WHITE" onclick="place('WHITE')"></div>
                    <div class="bet-card bg-YELLOW" onclick="place('YELLOW')"></div>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div style="padding:10px; border-bottom:1px solid var(--border);">CHAT</div>
            <div id="chatBox" style="flex:1; overflow-y:auto;"></div>
            <div style="padding:10px; display:flex;">
                <input id="cMsg" style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:8px;" placeholder="...">
                <button onclick="send()" style="background:var(--gold); border:none; font-weight:bold;">></button>
            </div>
        </div>
    </div>

    <audio id="bgm"></audio>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const audio = document.getElementById('bgm'); audio.volume = 0.3;
        let chip = 50;

        function toggleAuth() {
            const l = document.getElementById('boxLogin');
            const r = document.getElementById('boxReg');
            if(l.style.display === 'none') { l.style.display='block'; r.style.display='none'; }
            else { l.style.display='none'; r.style.display='block'; }
        }

        function doLogin() {
            const u = document.getElementById('lUser').value;
            const p = document.getElementById('lPass').value;
            socket.emit('auth_handshake', { type:'player', username:u, password:p });
        }

        function doReg() {
            const u = document.getElementById('rUser').value;
            const p = document.getElementById('rPass').value;
            if(u && p) socket.emit('register', { username:u, password:p });
            else document.getElementById('rErr').innerText = "Enter details";
        }

        socket.on('login_success', (d) => {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('gameUI').style.display = 'grid';
            document.getElementById('dUser').innerText = d.username;
            document.getElementById('dBal').innerText = d.balance;
            audio.play().catch(()=>{});
        });
        socket.on('login_error', (m) => { document.getElementById('lErr').innerText = m; document.getElementById('rErr').innerText = m; });

        // GAME
        socket.on('active_players_update', (list) => {
            const b = document.getElementById('pList'); b.innerHTML = '';
            list.forEach(u => {
                let col = u.role==='ADMIN' ? 'var(--gold)' : (u.role==='MOD' ? 'var(--cyan)' : 'white');
                b.innerHTML += `<div class="pl-item" style="padding:5px 10px; color:${col};">‚óè ${u.username}</div>`;
            });
        });

        function selChip(v) { chip = v; }
        function place(c) { socket.emit('place_bet', { color:c, amount:chip }); }
        socket.on('update_balance', (b) => document.getElementById('dBal').innerText = b);
        
        socket.on('timer_update', (t) => document.getElementById('gTimer').innerText = t);
        socket.on('game_rolling', () => document.getElementById('gStatus').innerText = "ROLLING...");
        socket.on('game_reset', () => document.getElementById('gStatus').innerText = "BETS OPEN");
        
        socket.on('game_result', (res) => {
            document.getElementById('gStatus').innerText = "RESULT";
            ['d1','d2','d3'].forEach((id, i) => document.getElementById(id).className = `die bg-${res[i]}`);
        });

        // CHAT
        function send() { const m = document.getElementById('cMsg').value; if(m) { socket.emit('chat_msg', m); document.getElementById('cMsg').value=''; }}
        socket.on('chat_broadcast', (d) => {
            const b = document.getElementById('chatBox');
            let col = d.role==='ADMIN' ? 'var(--gold)' : (d.role==='MOD' ? 'var(--cyan)' : 'white');
            b.innerHTML += `<div class="chat-msg"><b style="color:${col}">${d.user}:</b> ${d.msg}</div>`;
            b.scrollTop = b.scrollHeight;
        });

        // MUSIC
        socket.on('music_sync', (d) => {
            if(d.url && audio.src !== d.url) audio.src = d.url;
            if(d.playing) audio.play().catch(()=>{}); else audio.pause();
            if(Math.abs(audio.currentTime - d.seek) > 2) audio.currentTime = d.seek;
            document.getElementById('mTitle').innerText = d.title || 'Waiting...';
            document.getElementById('mArtist').innerText = d.artist || '';
        });
        socket.on('meta_update', (d) => {
            document.getElementById('mTitle').innerText = d.title;
            document.getElementById('mArtist').innerText = d.artist;
        });
    </script>
</body>
</html>
