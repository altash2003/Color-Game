<!DOCTYPE html>
<html>
<head>
    <title>Fantasy Color Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) { if(e.keyCode == 123) return false; }
    </script>

    <style>
        :root { --gold: #FFD700; --cyan: #00E5FF; --red: #ff4444; --blue: #2979FF; --yellow: #FFEA00; --glass-bg: rgba(15, 20, 25, 0.6); --border: rgba(255, 255, 255, 0.15); }
        body { font-family: 'Rajdhani', sans-serif; text-align: center; margin: 0; color: white; background: url('background.jpg') center/cover; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        .chat-font { font-family: 'VT323', monospace; font-size: 18px; letter-spacing: 1px; }

        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('background.jpg') center/cover; z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .auth-box { background: rgba(0, 0, 0, 0.85); border: 1px solid var(--border); padding: 40px; border-radius: 16px; width: 320px; text-align: center; }
        .auth-input { background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white; padding: 12px; width: 100%; margin-bottom: 10px; border-radius: 6px; box-sizing: border-box; text-align: center; font-size: 16px; }
        .auth-btn { background: var(--gold); border: none; padding: 12px; width: 100%; font-weight: 800; font-size: 18px; cursor: pointer; border-radius: 6px; color: #000; }

        .main-container { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; width: 95%; height: 90vh; max-width: 1600px; }
        .side-panel { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .game-wrapper { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* CHAT STYLES */
        .chat-msg { padding: 4px 10px; font-size: 16px; line-height: 1.2; }
        
        /* MUSIC */
        .music-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .music-pill { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.7); padding: 8px 20px; border-radius: 12px; border: 1px solid var(--border); min-width: 250px; }
        .title-wrap { width: 100%; overflow: hidden; white-space: nowrap; text-align: center; }
        .music-title { font-size: 14px; font-weight: 700; color: white; }
        .music-artist { font-size: 11px; color: var(--gold); text-transform: uppercase; }
        .marquee { animation: scroll-left 8s linear infinite; padding-left: 100%; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* ACTIVE PLAYERS */
        .pl-item { padding: 6px 10px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); display:flex; align-items:center; }
        .status-bullet { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .bullet-green { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .bullet-blue { background: var(--blue); box-shadow: 0 0 5px var(--blue); }
        .bullet-yellow { background: var(--yellow); }
        
        /* BETTING */
        .bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; padding: 20px; }
        .bet-card { height: 100px; border: 2px solid rgba(255,255,255,0.1); border-radius: 8px; position: relative; cursor: pointer; transition: 0.1s; }
        .bet-card:active { transform: scale(0.95); }
        .bg-RED { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
        .bg-GREEN { background: linear-gradient(135deg, #388e3c, #1b5e20); }
        .bg-BLUE { background: linear-gradient(135deg, #1976d2, #0d47a1); }
        .bg-PINK { background: linear-gradient(135deg, #f06292, #c2185b); }
        .bg-WHITE { background: linear-gradient(135deg, #f5f5f5, #bdbdbd); color: black; }
        .bg-YELLOW { background: linear-gradient(135deg, #fbc02d, #f57f17); color: black; }

        @media (max-width: 768px) { .main-container { display: flex; flex-direction: column; height: 100vh; gap: 0; } .side-panel { display: none; } }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <h1 style="color:var(--gold);">LOGIN</h1>
            <input type="text" id="uName" class="auth-input" placeholder="USERNAME">
            <input type="password" id="pPass" class="auth-input" placeholder="PASSWORD">
            <button onclick="doAuth('login')" class="auth-btn">ENTER</button>
            <div style="margin-top:15px; font-size:12px; cursor:pointer; text-decoration:underline;" onclick="doAuth('register')">Create Account</div>
            <div id="loginErr" style="color:var(--red); margin-top:10px;"></div>
        </div>
    </div>

    <div class="main-container" id="gameUI" style="display:none;">
        <div class="side-panel">
            <div style="padding:15px; border-bottom:1px solid var(--border); font-weight:bold; color:var(--gold);">ACTIVE PLAYERS</div>
            <div id="activeList" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="game-wrapper">
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; position:relative;">
                <div><div style="font-size:10px; color:#aaa;">PLAYER</div><div id="dispUser" style="font-weight:700;">GUEST</div></div>
                
                <div class="music-center">
                    <div class="music-pill">
                        <i class="fas fa-music" style="color:var(--gold);"></i>
                        <div style="width:150px; overflow:hidden;">
                            <div class="title-wrap"><span id="mTitle" class="music-title">Waiting...</span></div>
                            <div id="mArtist" class="music-artist"></div>
                        </div>
                        <select onchange="document.getElementById('bgMusic').volume=this.value" style="background:#000; color:white; border:1px solid #333; font-size:10px;">
                            <option value="0">0%</option><option value="0.05">5%</option><option value="0.1">10%</option><option value="0.25" selected>25%</option><option value="0.5">50%</option>
                        </select>
                    </div>
                </div>

                <div style="text-align:right;"><div style="font-size:10px; color:#aaa;">CREDITS</div><div id="balance" style="color:var(--gold); font-weight:800; font-size:20px;">0</div></div>
            </div>

            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div id="status" style="font-size:24px; color:#aaa; letter-spacing:3px; margin-bottom:10px;">BETS OPEN</div>
                <div id="timer" style="font-size:80px; font-weight:800;">20</div>
                <div style="display:flex; gap:20px; margin-top:20px;">
                    <div id="d1" style="width:80px; height:80px; background:#222; border-radius:10px;"></div>
                    <div id="d2" style="width:80px; height:80px; background:#222; border-radius:10px;"></div>
                    <div id="d3" style="width:80px; height:80px; background:#222; border-radius:10px;"></div>
                </div>
            </div>

            <div class="bet-grid">
                <div class="bet-card bg-RED" onclick="placeBet('RED')"></div>
                <div class="bet-card bg-GREEN" onclick="placeBet('GREEN')"></div>
                <div class="bet-card bg-BLUE" onclick="placeBet('BLUE')"></div>
                <div class="bet-card bg-PINK" onclick="placeBet('PINK')"></div>
                <div class="bet-card bg-WHITE" onclick="placeBet('WHITE')"></div>
                <div class="bet-card bg-YELLOW" onclick="placeBet('YELLOW')"></div>
            </div>
        </div>

        <div class="side-panel">
            <div style="display:flex; border-bottom:1px solid var(--border);">
                <button style="flex:1; padding:10px; background:transparent; border:none; color:white; font-weight:bold; cursor:pointer;" onclick="tab('public')">PUBLIC</button>
                <button style="flex:1; padding:10px; background:transparent; border:none; color:#888; font-weight:bold; cursor:pointer;" onclick="tab('support')">SUPPORT</button>
            </div>
            
            <div id="view-public" style="flex:1; display:flex; flex-direction:column;">
                <div id="chatList" class="chat-font" style="flex:1; overflow-y:auto; padding:10px;"></div>
                <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border);">
                    <input id="cInput" style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:8px;" placeholder="...">
                    <button onclick="sendChat()" style="background:var(--gold); border:none; font-weight:bold;">></button>
                </div>
            </div>

            <div id="view-support" style="flex:1; display:none; flex-direction:column;">
                <div id="suppList" class="chat-font" style="flex:1; overflow-y:auto; padding:10px;"></div>
                <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border);">
                    <input id="sInput" style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:8px;" placeholder="Help...">
                    <button onclick="sendSupp()" style="background:var(--cyan); border:none; font-weight:bold;">></button>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgMusic"></audio>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const audio = document.getElementById('bgMusic'); audio.volume = 0.25;
        let myUser = "";

        // IDLE DETECT
        document.addEventListener("visibilitychange", () => {
            socket.emit('status_update', document.hidden ? 'idle' : 'active');
        });

        function doAuth(type) {
            const u = document.getElementById('uName').value;
            const p = document.getElementById('pPass').value;
            if(type === 'login') socket.emit('auth_handshake', {type:'player', username:u, password:p});
            else socket.emit('register', {username:u, password:p});
        }

        socket.on('login_success', (d) => {
            document.getElementById('authOverlay').style.display='none';
            document.getElementById('gameUI').style.display='grid';
            document.getElementById('dispUser').innerText = d.username;
            document.getElementById('balance').innerText = d.balance;
            myUser = d.username;
            audio.play().catch(()=>{});
        });
        socket.on('login_error', (m) => document.getElementById('loginErr').innerText = m);

        // ACTIVE PLAYERS
        socket.on('active_players_update', (list) => {
            const el = document.getElementById('activeList'); el.innerHTML = "";
            list.forEach(u => {
                let bClass = 'bullet-yellow';
                if(!u.isIdle) bClass = 'bullet-green';
                if(u.hasBet) bClass = 'bullet-blue';
                
                let color = 'var(--yellow)';
                if(u.role === 'ADMIN') color = 'var(--red)';
                if(u.role === 'MOD') color = 'var(--blue)';
                
                el.innerHTML += `<div class="pl-item"><div class="status-bullet ${bClass}"></div><span style="color:${color}">${u.username}</span></div>`;
            });
        });

        // CHAT
        function sendChat() { const v = document.getElementById('cInput').value; if(v) { socket.emit('chat_msg', v); document.getElementById('cInput').value=''; }}
        function sendSupp() { const v = document.getElementById('sInput').value; if(v) { socket.emit('support_msg', v); document.getElementById('sInput').value=''; }}
        
        socket.on('chat_broadcast', (d) => {
            if(d.type.includes('public')) {
                const box = document.getElementById('chatList');
                const uColor = d.role === 'ADMIN' ? 'var(--red)' : (d.role === 'MOD' ? 'var(--blue)' : 'var(--yellow)');
                const mColor = (d.role === 'ADMIN' || d.role === 'MOD') ? 'var(--cyan)' : '#fff';
                box.innerHTML += `<div class="chat-msg"><b style="color:${uColor}">${d.user}:</b> <span style="color:${mColor}">${d.msg}</span></div>`;
                box.scrollTop = box.scrollHeight;
            } else if (d.type === 'support_sent' || d.type === 'support_reply') {
                const box = document.getElementById('suppList');
                const sender = d.type === 'support_sent' ? 'You' : 'ADMIN';
                const color = d.type === 'support_sent' ? '#888' : 'var(--cyan)';
                box.innerHTML += `<div class="chat-msg"><b style="color:${color}">${sender}:</b> ${d.msg}</div>`;
                box.scrollTop = box.scrollHeight;
            }
        });
        socket.on('chat_cleared', (s) => { if(s==='public') document.getElementById('chatList').innerHTML = '<div style="color:grey;text-align:center;">--- CLEARED ---</div>'; });

        // MUSIC
        socket.on('music_sync', (d) => {
            if(d.url && audio.src !== d.url) audio.src = d.url;
            if(d.playing) audio.play().catch(()=>{}); else audio.pause();
            if(Math.abs(audio.currentTime - d.seek) > 2) audio.currentTime = d.seek;
            document.getElementById('mTitle').innerText = d.title || 'Waiting...';
            document.getElementById('mArtist').innerText = d.artist || '';
            // Center logic
            if(!d.artist) { document.getElementById('mArtist').style.display='none'; } 
            else { document.getElementById('mArtist').style.display='block'; }
            // Marquee logic
            if((d.title||'').length > 20) document.getElementById('mTitle').className='music-title marquee';
            else document.getElementById('mTitle').className='music-title';
        });

        // BETTING (Basic)
        function placeBet(c) { socket.emit('place_bet', {color:c, amount:100}); } // Hardcoded 100 for brevity, add chip logic back if needed
        socket.on('update_balance', (b) => document.getElementById('balance').innerText = b);
        
        // GAME STATE
        socket.on('timer_update', (t) => document.getElementById('timer').innerText = t);
        socket.on('game_rolling', () => document.getElementById('status').innerText = "ROLLING...");
        socket.on('game_reset', () => document.getElementById('status').innerText = "BETS OPEN");
        
        function tab(t) {
            document.getElementById('view-public').style.display = t==='public'?'flex':'none';
            document.getElementById('view-support').style.display = t==='support'?'flex':'none';
        }
    </script>
</body>
</html>
