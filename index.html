<!DOCTYPE html>
<html>
<head>
    <title>Fantasy Color Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --gold: #FFD700; --cyan: #00E5FF; --glass-bg: rgba(15, 20, 25, 0.9); --border: rgba(255, 255, 255, 0.15); }
        body { font-family: 'Rajdhani', sans-serif; margin: 0; color: white; background: url('background.jpg') center/cover; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        #toastBox { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 10000; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.9); border: 1px solid var(--gold); padding: 10px 20px; margin-bottom: 5px; border-radius: 4px; color: var(--gold); font-weight: bold; animation: fadeUp 0.3s forwards; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* AUTH */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('background.jpg') center/cover; z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .auth-container { width: 320px; background: rgba(0,0,0,0.85); border: 1px solid var(--border); border-radius: 12px; padding: 30px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white; text-align: center; border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 16px; margin-top: 5px; }
        .btn-login { background: var(--gold); color: black; }
        .btn-reg { background: var(--cyan); color: black; }
        .toggle-link { font-size: 12px; color: #aaa; margin-top: 15px; cursor: pointer; text-decoration: underline; }

        /* LAYOUT */
        .main-container { display: grid; grid-template-columns: 260px 1fr 280px; gap: 20px; width: 95%; height: 90vh; max-width: 1600px; }
        .side-panel { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .game-wrapper { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); position: relative; }

        /* HEADER */
        .hud-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .music-pill { display: flex; align-items: center; gap: 15px; background: #000; padding: 8px 20px; border-radius: 30px; border: 1px solid #333; }
        .music-title { font-size: 12px; font-weight: 700; color: white; white-space: nowrap; max-width: 150px; overflow: hidden; }
        .music-artist { font-size: 10px; color: var(--gold); text-transform: uppercase; }

        /* GAME CENTER */
        .game-focus { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #status { font-size: 20px; letter-spacing: 3px; color: #ccc; margin-bottom: 5px; font-weight: 700; }
        #timer { font-size: 90px; font-weight: 800; line-height: 1; margin-bottom: 20px; }
        .dice-row { display: flex; gap: 20px; }
        .die { width: 70px; height: 70px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); background: #222; }
        .bg-RED { background: #d32f2f; } .bg-GREEN { background: #388e3c; } .bg-BLUE { background: #1976d2; } 
        .bg-PINK { background: #c2185b; } .bg-WHITE { background: #e0e0e0; } .bg-YELLOW { background: #fbc02d; }

        /* CONTROLS */
        .bet-controls { padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .chip-rack { display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 30px; }
        .chip { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #444; background: #222; color: #888; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .chip.active { border-color: var(--gold); color: var(--gold); transform: scale(1.1); }
        .btn-act { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 6px 15px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; }

        .bet-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 0 15px 15px 15px; }
        .bet-card { height: 90px; border-radius: 8px; cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: flex-end; padding: 10px; border: 2px solid rgba(255,255,255,0.1); transition: 0.1s; }
        .bet-card:active { transform: scale(0.96); }
        .card-val { font-size: 20px; font-weight: 800; text-align: center; width: 100%; }
        .card-lbl { font-size: 10px; font-weight: 700; opacity: 0.7; position: absolute; top: 8px; left: 8px; }

        /* CHAT */
        .chat-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: #888; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; border-bottom-color: var(--gold); background: rgba(255,255,255,0.05); }
        .chat-view { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; line-height: 1.4; text-align: left; }
        .chat-inp { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; }
        .inp-field { flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 8px; border-radius: 4px; color: white; outline: none; }

        @media (max-width: 800px) { .side-panel { display: none; } .main-container { display: flex; flex-direction: column; width: 100%; gap: 0; } .auth-container { width: 90%; } }
    </style>
</head>
<body>
    <div id="toastBox"></div>
    <audio id="bgMusic"></audio>

    <div id="authOverlay">
        <div id="loginBox" class="auth-container">
            <h1 style="color:var(--gold); margin:0 0 20px 0;">LOGIN</h1>
            <input id="lUser" class="auth-input" placeholder="USERNAME">
            <input id="lPass" type="password" class="auth-input" placeholder="PASSWORD">
            <button onclick="doLogin()" class="auth-btn btn-login">ENTER</button>
            <div class="toggle-link" onclick="toggleAuth()">Create Account</div>
            <div id="lErr" style="color:#ff4444; margin-top:10px; font-size:12px;"></div>
        </div>
        <div id="regBox" class="auth-container" style="display:none;">
            <h1 style="color:var(--cyan); margin:0 0 20px 0;">REGISTER</h1>
            <input id="rUser" class="auth-input" placeholder="NEW USERNAME">
            <input id="rPass" type="password" class="auth-input" placeholder="NEW PASSWORD">
            <button onclick="doReg()" class="auth-btn btn-reg">CREATE</button>
            <div class="toggle-link" onclick="toggleAuth()">Back to Login</div>
            <div id="rErr" style="color:#ff4444; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="main-container" id="gameUI" style="display:none;">
        <div class="side-panel">
            <div style="padding:15px; border-bottom:1px solid var(--border); color:var(--gold); font-weight:bold; font-size:12px;">ACTIVE PLAYERS</div>
            <div id="pList" style="flex:1; overflow-y:auto; padding:10px; text-align:left;"></div>
        </div>

        <div class="game-wrapper">
            <div class="hud-header">
                <div><div style="font-size:10px; color:#aaa;">PLAYER</div><div id="dUser" style="font-weight:700;">GUEST</div></div>
                <div class="music-pill">
                    <i class="fas fa-music" style="color:var(--gold);"></i>
                    <div><div id="mTitle" class="music-title">Waiting...</div><div id="mArtist" class="music-artist"></div></div>
                    <input type="range" min="0" max="1" step="0.1" style="width:50px; accent-color:var(--gold);" onchange="document.getElementById('bgMusic').volume=this.value">
                </div>
                <div style="text-align:right;"><div style="font-size:10px; color:#aaa;">CREDITS</div><div id="dBal" style="font-size:24px; font-weight:800; color:var(--gold);">0</div></div>
            </div>

            <div class="game-focus">
                <div id="status">BETS OPEN</div>
                <div id="timer">20</div>
                <div class="dice-row">
                    <div id="d1" class="die"></div><div id="d2" class="die"></div><div id="d3" class="die"></div>
                </div>
            </div>

            <div class="bet-controls">
                <div class="chip-rack">
                    <div class="chip active" onclick="selChip(50, this)">50</div>
                    <div class="chip" onclick="selChip(100, this)">100</div>
                    <div class="chip" onclick="selChip(1000, this)">1K</div>
                    <div class="chip" onclick="selChip(10000, this)">10K</div>
                    <div class="chip" onclick="selChip(100000, this)">100K</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-act" onclick="socket.emit('undo_bet')"><i class="fas fa-undo"></i> UNDO</button>
                    <button class="btn-act" onclick="socket.emit('clear_bets')"><i class="fas fa-trash"></i> CLEAR</button>
                </div>
            </div>

            <div class="bet-grid">
                <div class="bet-card bg-RED" onclick="place('RED')"><div class="card-lbl">RED</div><div id="bRED" class="card-val">0</div></div>
                <div class="bet-card bg-GREEN" onclick="place('GREEN')"><div class="card-lbl">GREEN</div><div id="bGREEN" class="card-val">0</div></div>
                <div class="bet-card bg-BLUE" onclick="place('BLUE')"><div class="card-lbl">BLUE</div><div id="bBLUE" class="card-val">0</div></div>
                <div class="bet-card bg-PINK" onclick="place('PINK')"><div class="card-lbl">PINK</div><div id="bPINK" class="card-val">0</div></div>
                <div class="bet-card bg-WHITE" onclick="place('WHITE')"><div class="card-lbl">WHITE</div><div id="bWHITE" class="card-val">0</div></div>
                <div class="bet-card bg-YELLOW" onclick="place('YELLOW')"><div class="card-lbl">YELLOW</div><div id="bYELLOW" class="card-val">0</div></div>
            </div>
            <div style="text-align:center; font-size:10px; color:#aaa; padding-bottom:10px;">x2 [1 Match] x3 [2 Matches] x4 [3 Matches] | TOP-UP: @ASHLEY.GG | 1 TRADECASH = 1 CREDIT</div>
        </div>

        <div class="side-panel">
            <div class="chat-tabs">
                <button id="tPub" class="tab-btn active" onclick="tab('pub')">PUBLIC</button>
                <button id="tSup" class="tab-btn" onclick="tab('sup')">SUPPORT</button>
            </div>
            <div id="vPub" class="chat-view" style="display:flex;">
                <div id="cPub" class="chat-list"></div>
                <div class="chat-inp"><input id="iPub" class="inp-field" placeholder="Chat..."><button onclick="send('pub')" style="background:var(--gold); border:none; padding:0 10px; font-weight:bold;">></button></div>
            </div>
            <div id="vSup" class="chat-view">
                <div id="cSup" class="chat-list"></div>
                <div class="chat-inp"><input id="iSup" class="inp-field" placeholder="Help..."><button onclick="send('sup')" style="background:var(--cyan); border:none; padding:0 10px; font-weight:bold;">></button></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const audio = document.getElementById('bgMusic'); audio.volume=0.3;
        let chip = 50; let curBal = 0; let roundBets = {};

        function toggleAuth() { 
            const l=document.getElementById('loginBox'), r=document.getElementById('regBox');
            if(l.style.display==='none') { l.style.display='block'; r.style.display='none'; } else { l.style.display='none'; r.style.display='block'; }
        }
        function doLogin() { socket.emit('auth_handshake', {type:'player', username:document.getElementById('lUser').value, password:document.getElementById('lPass').value}); }
        function doReg() { 
            const u=document.getElementById('rUser').value, p=document.getElementById('rPass').value;
            if(u&&p) socket.emit('register', {username:u, password:p});
        }

        socket.on('login_success', (d) => {
            document.getElementById('authOverlay').style.display='none';
            document.getElementById('gameUI').style.display='grid';
            document.getElementById('dUser').innerText = d.username;
            document.getElementById('dBal').innerText = d.balance;
            curBal = d.balance;
            audio.play().catch(()=>{});
        });
        socket.on('login_error', (m) => { document.getElementById('lErr').innerText = m; document.getElementById('rErr').innerText = m; });

        // ACTIVE PLAYERS
        socket.on('active_players_update', (list) => {
            const b = document.getElementById('pList'); b.innerHTML = '';
            list.forEach(u => {
                let c = u.role==='ADMIN'?'var(--gold)':(u.role==='MOD'?'var(--cyan)':'white');
                b.innerHTML += `<div style="color:${c}; font-size:13px; margin-bottom:4px;"><i class="fas fa-circle" style="font-size:8px; margin-right:5px;"></i> ${u.username}</div>`;
            });
        });

        // GAME
        function selChip(v, el) { chip=v; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        function place(c) {
            if(curBal < chip) { showToast("NO CREDITS"); return; }
            curBal -= chip; document.getElementById('dBal').innerText = curBal;
            if(!roundBets[c]) roundBets[c]=0; roundBets[c]+=chip;
            document.getElementById('b'+c).innerText = roundBets[c];
            socket.emit('place_bet', {color:c, amount:chip});
        }
        socket.on('update_balance', (b) => { curBal=b; document.getElementById('dBal').innerText = b; });
        socket.on('bet_undone', (d) => {
            if(roundBets[d.color]) { roundBets[d.color]-=d.amount; document.getElementById('b'+d.color).innerText=roundBets[d.color]; curBal+=d.amount; document.getElementById('dBal').innerText=curBal; }
        });
        socket.on('bets_cleared', () => { roundBets={}; document.querySelectorAll('.card-val').forEach(e=>e.innerText='0'); });
        socket.on('game_reset', () => { roundBets={}; document.querySelectorAll('.card-val').forEach(e=>e.innerText='0'); });

        socket.on('timer_update', (t) => { document.getElementById('timer').innerText = t; document.getElementById('status').innerText="BETS OPEN"; document.getElementById('status').style.color="#ccc"; });
        socket.on('game_rolling', () => { document.getElementById('status').innerText="ROLLING..."; document.getElementById('status').style.color="var(--gold)"; });
        socket.on('game_result', (r) => {
            document.getElementById('status').innerText="RESULT"; document.getElementById('status').style.color="white";
            ['d1','d2','d3'].forEach((id, i) => document.getElementById(id).className = `die bg-${r[i]}`);
        });
        socket.on('win_notification', (d) => { showToast(`WON +${d.total} CREDITS!`); });
        socket.on('bet_error', (m) => showToast(m));

        function showToast(m) {
            const t = document.createElement('div'); t.className='toast'; t.innerText=m;
            document.getElementById('toastBox').appendChild(t); setTimeout(()=>t.remove(), 3000);
        }

        // CHAT
        function tab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.chat-view').forEach(v=>v.style.display='none');
            document.getElementById('t'+(t==='pub'?'Pub':'Sup')).classList.add('active');
            document.getElementById('v'+(t==='pub'?'Pub':'Sup')).style.display='flex';
        }
        function send(t) {
            const i = document.getElementById(t==='pub'?'iPub':'iSup');
            if(i.value) { socket.emit(t==='pub'?'chat_msg':'support_msg', i.value); i.value=''; }
        }
        socket.on('chat_broadcast', (d) => {
            if(d.type==='public') {
                const b = document.getElementById('cPub');
                let c = d.role==='ADMIN'?'var(--gold)':(d.role==='MOD'?'var(--cyan)':'white');
                b.innerHTML += `<div><b style="color:${c}">${d.user}:</b> ${d.msg}</div>`; b.scrollTop=b.scrollHeight;
            } else {
                const b = document.getElementById('cSup');
                let c = d.type==='support_sent'?'#aaa':'var(--cyan)';
                let u = d.type==='support_sent'?'You':'ADMIN';
                b.innerHTML += `<div><b style="color:${c}">${u}:</b> ${d.msg}</div>`; b.scrollTop=b.scrollHeight;
            }
        });

        // MUSIC
        socket.on('music_sync', (d) => {
            if(d.url && audio.src!==d.url) audio.src=d.url;
            if(d.playing) audio.play().catch(()=>{}); else audio.pause();
            if(Math.abs(audio.currentTime - d.seek)>2) audio.currentTime=d.seek;
            document.getElementById('mTitle').innerText=d.title||'Waiting...';
            document.getElementById('mArtist').innerText=d.artist||'';
        });
        socket.on('meta_update', (d) => { document.getElementById('mTitle').innerText=d.title; document.getElementById('mArtist').innerText=d.artist; });
    </script>
</body>
</html>
